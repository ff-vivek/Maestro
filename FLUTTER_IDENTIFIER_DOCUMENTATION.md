# Flutter Web Identifier Documentation

## Table of Contents
1. [Overview](#overview)
2. [The Three Key Concepts](#the-three-key-concepts)
3. [How It Works End-to-End](#how-it-works-end-to-end)
4. [Flutter Implementation](#flutter-implementation)
5. [Maestro Implementation](#maestro-implementation)
6. [Usage Examples](#usage-examples)
7. [Code Reference](#code-reference)
8. [Best Practices](#best-practices)

---

## Overview

This document explains the Flutter web identifier system in Maestro, which enables stable, reliable testing of Flutter web applications by using developer-defined identifiers instead of auto-generated IDs.

### The Problem It Solves

Flutter web applications generate auto-generated IDs like `flt-semantic-node-42` that change between runs, making tests brittle and unreliable. The identifier system provides stable references that persist across rebuilds.

### The Solution

Flutter's `Semantics(identifier: ...)` property creates a stable `flt-semantics-identifier` HTML attribute that Maestro can use via the `flutter-id` selector.

---

## The Three Key Concepts

### 1. `flutter-id` (Maestro Selector)

**What it is:** A Maestro test selector that matches elements by their Flutter identifier.

**Where it's used:** In Maestro YAML test files.

**Syntax:**
```yaml
- tapOn:
    flutter-id: "submit_button"
```

**Purpose:** Provides a stable way to select elements in Maestro tests using Flutter's semantic identifiers.

**Naming Convention:** 
- **YAML:** `flutter-id` (kebab-case with hyphen)
- **Kotlin:** `flutterId` (camelCase)
- **Why kebab-case?** To match HTML/web conventions (e.g., `flt-semantics-identifier`, `resource-id`, `data-testid`)
- **Unique:** Only multi-word Maestro selector using kebab-case

---

### 2. `Semantics(identifier: value)` (Flutter Widget Property)

**What it is:** A property of Flutter's `Semantics` widget that sets a stable identifier.

**Where it's used:** In Flutter/Dart code.

**Syntax:**
```dart
Semantics(
  identifier: 'submit_button',
  button: true,
  label: 'Submit Form',
  child: ElevatedButton(...),
)
```

**Purpose:** Creates a developer-defined, stable identifier for semantic elements that doesn't change across rebuilds.

---

### 3. `flt-semantics-identifier` (HTML Attribute)

**What it is:** An HTML attribute generated by Flutter's web engine.

**Where it appears:** In the rendered HTML DOM of Flutter web apps.

**Syntax:**
```html
<flt-semantics
  id="flt-semantic-node-42"
  flt-semantics-identifier="submit_button"
  role="button">
  Submit Form
</flt-semantics>
```

**Purpose:** The bridge between Flutter code and the browser DOM, exposing the identifier for testing tools.

---

## How It Works End-to-End

### Complete Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Flutter Web Identifier Flow                          │
└─────────────────────────────────────────────────────────────────────────────┘

Step 1: Flutter Code                    Step 2: HTML DOM
────────────────────                    ────────────────
Semantics(                              <flt-semantics
  identifier: 'submit_button',    ───►    id="flt-semantic-node-42"
  button: true,                           flt-semantics-identifier="submit_button"
  label: 'Submit',                        role="button">
  child: ElevatedButton(...)              Submit
)                                       </flt-semantics>
        │                                       │
        │                                       │
        └───────────────────┬───────────────────┘
                            │
                            ▼
Step 3: maestro-web.js              Step 4: Filters.kt
──────────────────────              ──────────────────
attributes['flutter-id']     ───►   flutterIdMatches(flutterId)
  = 'submit_button'                   filters by flutter-id
                                             │
        ┌────────────────────────────────────┘
        │
        ▼
Step 5: WebDriver/CdpWebDriver      Step 6-7: YAML → ElementSelector
──────────────────────────          ────────────────────────────────
parseDomAsTreeNodes()               YamlElementSelector
  attributes["flutter-id"]    ───►    @JsonProperty("flutter-id")
  = "submit_button"                   val flutterId: String?
        │                                     │
        └─────────────────┬───────────────────┘
                          │
                          ▼
                  Step 8: Test Execution
                  ──────────────────────
                  - tapOn:
                      flutter-id: "submit_button"
                          │
                          ▼
                   Element Found ✅
                   Action Performed
```

### Step-by-Step Process

#### Step 1: Flutter Developer Sets Identifier

```dart
Semantics(
  identifier: 'submit_button',  // Developer defines this
  button: true,
  label: 'Submit Form',
  enabled: true,
  child: ElevatedButton(
    onPressed: () => submitForm(),
    child: Text('Submit'),
  ),
)
```

#### Step 2: Flutter Web Engine Generates HTML

```html
<flt-semantics
  id="flt-semantic-node-42"                    <!-- Auto-generated, unstable -->
  flt-semantics-identifier="submit_button"     <!-- From identifier property -->
  role="button"
  flt-tappable>
  Submit Form
</flt-semantics>
```

#### Step 3: Maestro's JavaScript Extracts the Identifier

**File:** `maestro-web.js` (lines 96-100)

```javascript
// Extract Flutter semantics identifier as a separate attribute
const fltSemanticsId = node.getAttribute ? node.getAttribute('flt-semantics-identifier') : null
if (!!fltSemanticsId) {
  attributes['flutter-id'] = fltSemanticsId
}
```

This code:
1. Checks if the DOM element has `flt-semantics-identifier` attribute
2. If found, stores it as `flutter-id` in the element attributes
3. Makes it available to Maestro's filtering system

#### Step 4: Maestro's Kotlin Code Creates Filter

**File:** `Filters.kt` (lines 124-130)

```kotlin
fun flutterIdMatches(flutterId: String): ElementFilter {
    return { nodes ->
        nodes.filter {
            it.attributes["flutter-id"] == flutterId
        }
    }
}
```

This filter:
1. Takes a `flutterId` string (e.g., "submit_button")
2. Filters all nodes to find those with matching `flutter-id` attribute
3. Returns only matching elements

#### Step 5: WebDriver Parses Attributes

**Files:** 
- `WebDriver.kt` (lines 228-230)
- `CdpWebDriver.kt` (lines 272-274)

```kotlin
if (attrs.containsKey("flutter-id") && attrs["flutter-id"] != null) {
    attributes["flutter-id"] = attrs["flutter-id"] as String
}
```

This ensures the `flutter-id` attribute is properly passed through the view hierarchy.

**Note:** Maestro has two web driver implementations that both support flutter-id:
- **`WebDriver`** - Standard Selenium-based web driver
- **`CdpWebDriver`** - Chrome DevTools Protocol (CDP) based driver for better performance

Both parse the `flutter-id` attribute identically.

#### Step 6: YAML Selector Definition

**File:** `YamlElementSelector.kt` (line 29)

```kotlin
@JsonDeserialize(`as` = YamlElementSelector::class)
data class YamlElementSelector(
    val text: String? = null,
    val id: String? = null,
    @JsonProperty("flutter-id") val flutterId: String? = null,  // ← Defined here
    val width: Int? = null,
    val height: Int? = null,
    // ... other selectors
)
```

**Key Points:**
- Uses `@JsonProperty("flutter-id")` annotation to map kebab-case YAML to camelCase Kotlin
- The Kotlin property is named `flutterId` (camelCase)
- The YAML selector is `flutter-id` (kebab-case with hyphen)
- This is the only multi-word selector in Maestro that uses kebab-case

#### Step 7: Element Selector Model

**File:** `ElementSelector.kt` (lines 28 and 82-84)

```kotlin
data class ElementSelector(
    val textRegex: String? = null,
    val idRegex: String? = null,
    val flutterId: String? = null,  // ← Stored here
    // ... other properties
) {
    fun description(): String {
        val descriptions = mutableListOf<String>()
        
        // ... other descriptions
        
        flutterId?.let {
            descriptions.add("flutter-id: $it")  // ← Displayed in logs
        }
        
        // ... more descriptions
    }
}
```

**Key Points:**
- The model uses `flutterId` as the Kotlin property name
- The `description()` method outputs it as `flutter-id` for user-facing logs
- This model is used throughout Maestro's orchestration layer

#### Step 8: Test Uses flutter-id Selector

**File:** `test_flutter_identifier.yaml`

```yaml
- tapOn:
    flutter-id: "submit_button"
```

Maestro's element selection system:
1. YAML parser reads `flutter-id: "submit_button"` from test file
2. `YamlElementSelector` maps it to `flutterId` property via `@JsonProperty`
3. Converts to `ElementSelector` with `flutterId = "submit_button"`
4. Applies the `flutterIdMatches` filter
5. Finds the element with matching `flutter-id` attribute
6. Performs the tap action

---

## Flutter Implementation

### Basic Semantics with Identifier

```dart
Semantics(
  identifier: 'my_element',
  child: Widget(...),
)
```

### Button with Identifier

```dart
Semantics(
  identifier: 'submit_registration_form',
  button: true,
  label: 'Submit Registration Form',
  enabled: _isFormValid,
  child: ElevatedButton(
    onPressed: _isFormValid ? _handleSubmit : null,
    child: Text('Submit'),
  ),
)
```

**Generated HTML:**
```html
<flt-semantics
  id="flt-semantic-node-100"
  flt-semantics-identifier="submit_registration_form"
  role="button"
  aria-disabled="false"
  flt-tappable>
  Submit Registration Form
</flt-semantics>
```

### Text Field with Identifier

```dart
Semantics(
  identifier: 'username_field',
  textField: true,
  label: 'Username',
  value: _usernameController.text,
  child: TextField(
    controller: _usernameController,
    decoration: InputDecoration(labelText: 'Username'),
  ),
)
```

**Generated HTML:**
```html
<input
  type="text"
  id="flt-semantic-node-10"
  flt-semantics-identifier="username_field"
  aria-label="Username"
  value="">
```

### Checkbox with Identifier

```dart
Semantics(
  identifier: 'agree_checkbox',
  checked: _agreedToTerms,
  label: 'I agree to the terms and conditions',
  child: Checkbox(
    value: _agreedToTerms,
    onChanged: (value) => setState(() => _agreedToTerms = value),
  ),
)
```

**Generated HTML:**
```html
<flt-semantics
  id="flt-semantic-node-50"
  flt-semantics-identifier="agree_checkbox"
  role="checkbox"
  aria-checked="false"
  flt-tappable>
  I agree to the terms and conditions
</flt-semantics>
```

### Tab with Identifier

```dart
Semantics(
  identifier: 'profile_tab',
  role: SemanticsRole.tab,
  selected: _selectedTab == 1,
  label: 'Profile',
  child: Tab(text: 'Profile'),
)
```

**Generated HTML:**
```html
<flt-semantics
  id="flt-semantic-node-61"
  flt-semantics-identifier="profile_tab"
  role="tab"
  aria-selected="false"
  flt-tappable>
  Profile
</flt-semantics>
```

---

## Maestro Implementation

### Core JavaScript Extraction

**File:** `maestro-web.js` (lines 79-124)

```javascript
const traverse = (node, includeChildren = true) => {
  if (!node || isInvalidTag(node)) return null

  const children = includeChildren
    ? [...node.children || []].map(child => traverse(child)).filter(el => !!el)
    : []

  const attributes = {
      text: getNodeText(node),
      bounds: getNodeBounds(node),
  }

  // Extract Flutter semantics identifier as a separate attribute
  const fltSemanticsId = node.getAttribute ? node.getAttribute('flt-semantics-identifier') : null
  if (!!fltSemanticsId) {
    attributes['flutter-id'] = fltSemanticsId
  }
  
  if (!!node.id || !!node.ariaLabel || !!node.name || !!node.title || !!node.htmlFor || !!node.attributes['data-testid']) {
    const title = typeof node.title === 'string' ? node.title : null
    attributes['resource-id'] = node.id || node.ariaLabel || node.name || title || node.htmlFor || node.attributes['data-testid']?.value
  }

  // ... rest of the code

  return {
    attributes,
    children,
  }
}
```

**Key Points:**
- Extracts `flt-semantics-identifier` as a **separate** attribute called `flutter-id`
- Does NOT overwrite the `resource-id` field
- Maintains backward compatibility with existing tests

### Kotlin Filter Implementation

**File:** `Filters.kt` (lines 124-130)

```kotlin
fun flutterIdMatches(flutterId: String): ElementFilter {
    return { nodes ->
        nodes.filter {
            it.attributes["flutter-id"] == flutterId
        }
    }
}
```

**Usage in Element Selection:**
```kotlin
// When Maestro encounters flutter-id selector
val filter = Filters.flutterIdMatches("submit_button")
val matchingElements = filter(allNodes)
```

### WebDriver Attribute Parsing

Maestro has **two web driver implementations**, both supporting flutter-id identically:

#### WebDriver (Selenium-based)

**File:** `WebDriver.kt` (lines 218-244)

```kotlin
fun parseDomAsTreeNodes(domRepresentation: Map<String, Any>): TreeNode {
    val attrs = domRepresentation["attributes"] as Map<String, Any>

    val attributes = mutableMapOf(
        "text" to attrs["text"] as String,
        "bounds" to attrs["bounds"] as String,
    )
    if (attrs.containsKey("resource-id") && attrs["resource-id"] != null) {
        attributes["resource-id"] = attrs["resource-id"] as String
    }
    if (attrs.containsKey("flutter-id") && attrs["flutter-id"] != null) {
        attributes["flutter-id"] = attrs["flutter-id"] as String
    }
    if (attrs.containsKey("selected") && attrs["selected"] != null) {
        attributes["selected"] = (attrs["selected"] as Boolean).toString()
    }
    // ... more attributes

    val children = domRepresentation["children"] as List<Map<String, Any>>

    return TreeNode(attributes = attributes, children = children.map { parseDomAsTreeNodes(it) })
}
```

#### CdpWebDriver (Chrome DevTools Protocol)

**File:** `CdpWebDriver.kt` (lines 262-288)

```kotlin
fun parseDomAsTreeNodes(domRepresentation: Map<String, Any>): TreeNode {
    val attrs = domRepresentation["attributes"] as Map<String, Any>

    val attributes = mutableMapOf(
        "text" to attrs["text"] as String,
        "bounds" to attrs["bounds"] as String,
    )
    if (attrs.containsKey("resource-id") && attrs["resource-id"] != null) {
        attributes["resource-id"] = attrs["resource-id"] as String
    }
    if (attrs.containsKey("flutter-id") && attrs["flutter-id"] != null) {
        attributes["flutter-id"] = attrs["flutter-id"] as String
    }
    if (attrs.containsKey("selected") && attrs["selected"] != null) {
        attributes["selected"] = (attrs["selected"] as Boolean).toString()
    }
    // ... identical to WebDriver

    val children = domRepresentation["children"] as List<Map<String, Any>>

    return TreeNode(attributes = attributes, children = children.map { parseDomAsTreeNodes(it) })
}
```

**Key Points:**
- Both drivers parse `flutter-id` from JavaScript-extracted attributes identically
- Both preserve it in the TreeNode structure
- Both make it available for filtering
- **`CdpWebDriver`** uses Chrome DevTools Protocol for potentially better performance
- **`WebDriver`** uses standard Selenium WebDriver for broader browser compatibility

---

## Usage Examples

### Example 1: Simple Button Tap

**Flutter Code:**
```dart
Semantics(
  identifier: 'login_button',
  button: true,
  label: 'Log In',
  child: ElevatedButton(
    onPressed: () => login(),
    child: Text('Log In'),
  ),
)
```

**Maestro Test:**
```yaml
- tapOn:
    flutter-id: "login_button"
```

**Alternative (text-based):**
```yaml
- tapOn: "Log In"
```

### Example 2: Form Fill with Flutter Identifiers

**Flutter Code:**
```dart
Column(
  children: [
    Semantics(
      identifier: 'username_field',
      textField: true,
      label: 'Username',
      child: TextField(...),
    ),
    Semantics(
      identifier: 'password_field',
      textField: true,
      label: 'Password',
      child: TextField(obscureText: true, ...),
    ),
    Semantics(
      identifier: 'submit_button',
      button: true,
      label: 'Sign In',
      child: ElevatedButton(...),
    ),
  ],
)
```

**Maestro Test:**
```yaml
- tapOn:
    flutter-id: "username_field"
- inputText: "john_doe"

- tapOn:
    flutter-id: "password_field"
- inputText: "SecurePassword123"

- tapOn:
    flutter-id: "submit_button"
```

### Example 3: Checkbox Interaction

**Flutter Code:**
```dart
Semantics(
  identifier: 'remember_me_checkbox',
  checked: _rememberMe,
  label: 'Remember me',
  child: Checkbox(
    value: _rememberMe,
    onChanged: (value) => setState(() => _rememberMe = value!),
  ),
)
```

**Maestro Test:**
```yaml
# Tap to check
- tapOn:
    flutter-id: "remember_me_checkbox"

# Verify it's checked
- assertVisible:
    flutter-id: "remember_me_checkbox"
    checked: true
```

### Example 4: Tab Navigation

**Flutter Code:**
```dart
TabBar(
  children: [
    Semantics(
      identifier: 'home_tab',
      role: SemanticsRole.tab,
      selected: _currentTab == 0,
      label: 'Home',
      child: Tab(text: 'Home'),
    ),
    Semantics(
      identifier: 'profile_tab',
      role: SemanticsRole.tab,
      selected: _currentTab == 1,
      label: 'Profile',
      child: Tab(text: 'Profile'),
    ),
    Semantics(
      identifier: 'settings_tab',
      role: SemanticsRole.tab,
      selected: _currentTab == 2,
      label: 'Settings',
      child: Tab(text: 'Settings'),
    ),
  ],
)
```

**Maestro Test:**
```yaml
# Verify home tab is selected
- assertVisible:
    flutter-id: "home_tab"
    selected: true

# Switch to profile tab
- tapOn:
    flutter-id: "profile_tab"

# Verify profile tab is now selected
- assertVisible:
    flutter-id: "profile_tab"
    selected: true

# Verify home tab is no longer selected
- assertVisible:
    flutter-id: "home_tab"
    selected: false
```

### Example 5: Combining flutter-id with Other Selectors

**Flutter Code:**
```dart
Semantics(
  identifier: 'submit_form_button',
  button: true,
  label: 'Submit Form',
  enabled: _isFormValid,  // Only enabled when form is valid
  child: ElevatedButton(...),
)
```

**Maestro Test:**
```yaml
# Verify button is initially disabled
- assertVisible:
    flutter-id: "submit_form_button"
    enabled: false

# Fill out the form
- tapOn:
    flutter-id: "name_field"
- inputText: "John Doe"

- tapOn:
    flutter-id: "email_field"
- inputText: "john@example.com"

# Wait for button to become enabled
- extendedWaitUntil:
    visible:
      flutter-id: "submit_form_button"
      enabled: true
    timeout: 3000

# Now tap the enabled button
- tapOn:
    flutter-id: "submit_form_button"
    enabled: true
```

### Example 6: Complete Login Flow

**Flutter Code:**
```dart
class LoginScreen extends StatefulWidget {
  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _rememberMe = false;
  
  bool get _isFormValid => 
    _emailController.text.isNotEmpty && 
    _passwordController.text.length >= 6;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          Semantics(
            identifier: 'login_header',
            header: true,
            headingLevel: 1,
            label: 'Login',
            child: Text('Login', style: Theme.of(context).textTheme.headline1),
          ),
          Semantics(
            identifier: 'email_field',
            textField: true,
            label: 'Email',
            value: _emailController.text,
            child: TextField(
              controller: _emailController,
              decoration: InputDecoration(labelText: 'Email'),
              onChanged: (_) => setState(() {}),
            ),
          ),
          Semantics(
            identifier: 'password_field',
            textField: true,
            label: 'Password',
            value: _passwordController.text,
            obscured: true,
            child: TextField(
              controller: _passwordController,
              decoration: InputDecoration(labelText: 'Password'),
              obscureText: true,
              onChanged: (_) => setState(() {}),
            ),
          ),
          Semantics(
            identifier: 'remember_me_checkbox',
            checked: _rememberMe,
            label: 'Remember me',
            child: CheckboxListTile(
              value: _rememberMe,
              onChanged: (value) => setState(() => _rememberMe = value!),
              title: Text('Remember me'),
            ),
          ),
          Semantics(
            identifier: 'login_button',
            button: true,
            label: 'Sign In',
            enabled: _isFormValid,
            child: ElevatedButton(
              onPressed: _isFormValid ? _handleLogin : null,
              child: Text('Sign In'),
            ),
          ),
        ],
      ),
    );
  }
  
  void _handleLogin() {
    // Login logic
  }
}
```

**Maestro Test:**
```yaml
appId: https://myapp.example.com
---
# Wait for login screen to appear
- assertVisible:
    flutter-id: "login_header"

# Verify submit button is initially disabled
- assertVisible:
    flutter-id: "login_button"
    enabled: false

# Enter email
- tapOn:
    flutter-id: "email_field"
- inputText: "user@example.com"

# Enter password
- tapOn:
    flutter-id: "password_field"
- inputText: "SecurePassword123"

# Wait for button to become enabled
- extendedWaitUntil:
    visible:
      flutter-id: "login_button"
      enabled: true
    timeout: 3000

# Check "Remember me"
- tapOn:
    flutter-id: "remember_me_checkbox"

- assertVisible:
    flutter-id: "remember_me_checkbox"
    checked: true

# Tap Sign In button
- tapOn:
    flutter-id: "login_button"
    enabled: true

# Verify successful login
- assertVisible: "Welcome"
```

---

## Code Reference

### Complete File Locations

| Component | File Path | Purpose |
|-----------|-----------|---------|
| JavaScript Extractor | `maestro-client/src/main/resources/maestro-web.js` | Extracts `flt-semantics-identifier` from DOM |
| Kotlin Filter | `maestro-client/src/main/java/maestro/Filters.kt` | Filters elements by `flutter-id` |
| WebDriver Parser (Selenium) | `maestro-client/src/main/java/maestro/drivers/WebDriver.kt` | Parses and passes `flutter-id` attribute |
| CdpWebDriver Parser (CDP) | `maestro-client/src/main/java/maestro/drivers/CdpWebDriver.kt` | Parses and passes `flutter-id` attribute (CDP-based) |
| YAML Selector Definition | `maestro-orchestra/src/main/java/maestro/orchestra/yaml/YamlElementSelector.kt` | Defines `flutter-id` YAML selector |
| Element Selector Model | `maestro-orchestra-models/src/main/java/maestro/orchestra/ElementSelector.kt` | Element selector data model with `flutterId` property |
| Test Example | `e2e/workspaces/flutter_web_identifier/test_flutter_identifier.yaml` | Demonstrates usage |
| HTML Test App | `e2e/workspaces/flutter_web_identifier/test_app.html` | Simulates Flutter web app |
| Documentation | `e2e/workspaces/flutter_web_identifier/README.md` | Feature overview |

### Key Code Snippets

#### maestro-web.js (Lines 96-100)
```javascript
// Extract Flutter semantics identifier as a separate attribute
const fltSemanticsId = node.getAttribute ? node.getAttribute('flt-semantics-identifier') : null
if (!!fltSemanticsId) {
  attributes['flutter-id'] = fltSemanticsId
}
```

#### Filters.kt (Lines 124-130)
```kotlin
fun flutterIdMatches(flutterId: String): ElementFilter {
    return { nodes ->
        nodes.filter {
            it.attributes["flutter-id"] == flutterId
        }
    }
}
```

#### WebDriver.kt (Lines 228-230) and CdpWebDriver.kt (Lines 272-274)
```kotlin
if (attrs.containsKey("flutter-id") && attrs["flutter-id"] != null) {
    attributes["flutter-id"] = attrs["flutter-id"] as String
}
```

**Note:** Both `WebDriver` (Selenium) and `CdpWebDriver` (Chrome DevTools Protocol) implementations parse flutter-id identically.

---

## Best Practices

### 1. Always Set Both `identifier` and `label`

✅ **Recommended:**
```dart
Semantics(
  identifier: 'submit_registration_form',  // For flutter-id selector
  label: 'Submit Registration Form',       // For text selector and accessibility
  button: true,
  child: ElevatedButton(...),
)
```

**Why:**
- `identifier`: Provides stable `flutter-id` selector
- `label`: Provides `text` selector and improves accessibility
- Enables flexible test strategies

❌ **Not Recommended:**
```dart
Semantics(
  identifier: 'submit_button',  // Only identifier, no label
  button: true,
  child: ElevatedButton(...),
)
```

### 2. Use Descriptive, Unique Identifiers

✅ **Good:**
```dart
Semantics(
  identifier: 'user_profile_avatar',
  identifier: 'submit_registration_form',
  identifier: 'delete_account_button',
)
```

❌ **Bad:**
```dart
Semantics(
  identifier: 'btn1',
  identifier: 'field2',
  identifier: 'checkbox',
)
```

**Naming Convention:**
- Use `snake_case`
- Be specific and descriptive
- Include context (e.g., `profile_tab` instead of just `tab`)
- Avoid generic names (e.g., `button`, `field`)

### 3. Choose the Right Selector for the Situation

**Use `flutter-id` when:**
- Multiple elements have similar text
- Element text changes based on state/locale
- You need guaranteed stability across rebuilds
- Working with complex UIs with many similar elements

```yaml
- tapOn:
    flutter-id: "submit_registration_form"
```

**Use `text` when:**
- Element has unique, stable text
- Testing user-facing content
- Text is unlikely to change

```yaml
- tapOn: "Submit Registration Form"
```

**Combine both for maximum reliability:**
```yaml
- tapOn:
    flutter-id: "submit_button"
    text: "Submit"
```

### 4. Combine with State Selectors

```yaml
# Wait for button to be enabled before tapping
- extendedWaitUntil:
    visible:
      flutter-id: "submit_button"
      enabled: true
    timeout: 5000

- tapOn:
    flutter-id: "submit_button"
    enabled: true
```

### 5. Use Hierarchical Organization

```dart
// Container with identifier
Semantics(
  identifier: 'user_profile_section',
  container: true,
  label: 'User Profile Section',
  child: Column(
    children: [
      Semantics(
        identifier: 'profile_name',
        label: _userName,
        child: Text(_userName),
      ),
      Semantics(
        identifier: 'profile_email',
        label: _userEmail,
        child: Text(_userEmail),
      ),
      Semantics(
        identifier: 'edit_profile_button',
        button: true,
        label: 'Edit Profile',
        child: ElevatedButton(...),
      ),
    ],
  ),
)
```

### 6. Document Your Identifiers

Keep a reference list of all identifiers in your app:

```dart
// lib/accessibility/semantic_identifiers.dart
class SemanticIdentifiers {
  // Authentication
  static const String loginButton = 'login_button';
  static const String emailField = 'email_field';
  static const String passwordField = 'password_field';
  
  // Profile
  static const String profileTab = 'profile_tab';
  static const String editProfileButton = 'edit_profile_button';
  static const String profileAvatar = 'profile_avatar';
  
  // Settings
  static const String settingsTab = 'settings_tab';
  static const String notificationsToggle = 'notifications_toggle';
  static const String logoutButton = 'logout_button';
}
```

**Usage:**
```dart
Semantics(
  identifier: SemanticIdentifiers.loginButton,
  button: true,
  label: 'Log In',
  child: ElevatedButton(...),
)
```

### 7. Test Both Positive and Negative States

```yaml
# Test enabled state
- assertVisible:
    flutter-id: "submit_button"
    enabled: true

# Test disabled state
- assertVisible:
    flutter-id: "submit_button"
    enabled: false

# Test checked state
- assertVisible:
    flutter-id: "agree_checkbox"
    checked: true

# Test unchecked state
- assertVisible:
    flutter-id: "agree_checkbox"
    checked: false
```

### 8. Avoid Over-Using Identifiers

**Not everything needs an identifier:**

❌ **Over-identified:**
```dart
Semantics(
  identifier: 'static_text_1',  // Unnecessary
  label: 'Welcome to our app',
  child: Text('Welcome to our app'),
)
```

✅ **Better:**
```dart
Text('Welcome to our app')  // No semantic needed for static text
```

**Use identifiers primarily for:**
- Interactive elements (buttons, fields, checkboxes)
- Dynamic content that changes
- Elements that need to be referenced in tests
- Elements with ARIA relationships (`controlsNodes`)

### 9. Maintain Backward Compatibility

When adding identifiers to existing widgets, keep the labels:

```dart
// Before
Semantics(
  label: 'Submit',
  button: true,
  child: ElevatedButton(...),
)

// After - ADD identifier, don't REPLACE label
Semantics(
  identifier: 'submit_button',  // New
  label: 'Submit',               // Keep existing
  button: true,
  child: ElevatedButton(...),
)
```

### 10. Use Consistent Patterns Across Your App

**Establish conventions:**
```dart
// Button pattern: {action}_{context}_button
identifier: 'submit_registration_form_button'
identifier: 'cancel_edit_profile_button'
identifier: 'delete_account_button'

// Field pattern: {field_name}_field
identifier: 'username_field'
identifier: 'email_field'
identifier: 'password_field'

// Tab pattern: {section}_tab
identifier: 'home_tab'
identifier: 'profile_tab'
identifier: 'settings_tab'

// Checkbox pattern: {purpose}_checkbox
identifier: 'agree_terms_checkbox'
identifier: 'remember_me_checkbox'
identifier: 'enable_notifications_checkbox'
```

---

## Comparison: Before vs After

### Before (Unstable IDs)

**Flutter:**
```dart
Semantics(
  button: true,
  label: 'Submit',
  child: ElevatedButton(...),
)
```

**HTML:**
```html
<flt-semantics
  id="flt-semantic-node-42"  <!-- Changes between runs -->
  role="button">
  Submit
</flt-semantics>
```

**Maestro Test (Fragile):**
```yaml
# ❌ Breaks when semantic tree is rebuilt
- tapOn:
    id: "flt-semantic-node-42"

# ✅ More reliable, but limited
- tapOn: "Submit"
```

### After (Stable Identifiers)

**Flutter:**
```dart
Semantics(
  identifier: 'submit_form_button',  // Stable
  button: true,
  label: 'Submit',
  child: ElevatedButton(...),
)
```

**HTML:**
```html
<flt-semantics
  id="flt-semantic-node-42"                  <!-- Still changes -->
  flt-semantics-identifier="submit_form_button"  <!-- Stable ✅ -->
  role="button">
  Submit
</flt-semantics>
```

**Maestro Test (Reliable):**
```yaml
# ✅ Best: Stable and semantic
- tapOn:
    flutter-id: "submit_form_button"

# ✅ Also works: Text-based
- tapOn: "Submit"

# ✅ Maximum reliability: Combine both
- tapOn:
    flutter-id: "submit_form_button"
    text: "Submit"
```

---

## Troubleshooting

### Issue: flutter-id selector not finding element

**Possible causes:**
1. Flutter code doesn't set `identifier` property
2. Identifier name mismatch
3. Element not yet rendered

**Solution:**
```yaml
# Add wait
- extendedWaitUntil:
    visible:
      flutter-id: "submit_button"
    timeout: 5000

# Then interact
- tapOn:
    flutter-id: "submit_button"
```

### Issue: Multiple elements with same flutter-id

**Cause:** Duplicate identifiers in Flutter code

**Solution:** Use unique identifiers
```dart
// ❌ Bad
Semantics(identifier: 'button', ...)
Semantics(identifier: 'button', ...)  // Duplicate!

// ✅ Good
Semantics(identifier: 'submit_button', ...)
Semantics(identifier: 'cancel_button', ...)
```

### Issue: Element has flutter-id but tap fails

**Cause:** Element might be disabled or obscured

**Solution:** Check element state
```yaml
# Verify element is enabled
- assertVisible:
    flutter-id: "submit_button"
    enabled: true

# Then tap
- tapOn:
    flutter-id: "submit_button"
```

---

## Summary

### Quick Reference Table

| Concept | Location | Syntax | Purpose |
|---------|----------|--------|---------|
| **Flutter Property** | Dart code | `identifier: 'my_id'` | Set stable identifier |
| **HTML Attribute** | Browser DOM | `flt-semantics-identifier="my_id"` | Bridge to web |
| **Maestro Selector** | YAML test | `flutter-id: "my_id"` | Select element |

### The Complete Cycle (8 Steps)

1. **Developer** sets `Semantics(identifier: 'submit_button', ...)` in Flutter code
2. **Flutter Web Engine** generates `<flt-semantics flt-semantics-identifier="submit_button">` HTML
3. **maestro-web.js** extracts it as `attributes['flutter-id'] = 'submit_button'`
4. **Filters.kt** provides `flutterIdMatches("submit_button")` filter function
5. **WebDriver/CdpWebDriver** parses DOM and preserves `flutter-id` attribute
6. **YamlElementSelector** defines `@JsonProperty("flutter-id")` mapping
7. **ElementSelector** model stores `flutterId` property
8. **Maestro Test** uses `flutter-id: "submit_button"` selector → **Element Found** ✅

### Benefits

✅ **Stable** - Identifiers don't change across rebuilds  
✅ **Readable** - Meaningful names instead of `flt-semantic-node-42`  
✅ **Reliable** - No dependency on auto-generated IDs  
✅ **Flexible** - Combine with other selectors  
✅ **Backward Compatible** - Existing tests still work  

---

## Additional Resources

- **Maestro Documentation:** https://maestro.mobile.dev/
- **Flutter Semantics:** https://api.flutter.dev/flutter/widgets/Semantics-class.html
- **Flutter Web Accessibility:** https://docs.flutter.dev/development/accessibility-and-localization/accessibility
- **Implementation Summary:** [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)
- **Test Examples:** [e2e/workspaces/flutter_web_identifier/](e2e/workspaces/flutter_web_identifier/)

---

*Last Updated: November 2025*

